{
	"annotations": {
		"list": [
			{
				"builtIn": 1,
				"datasource": "-- Grafana --",
				"enable": true,
				"hide": true,
				"iconColor": "rgba(0, 211, 255, 1)",
				"name": "Annotations & Alerts",
				"type": "dashboard"
			}
		]
	},
	"editable": true,
	"fiscalYearStartMonth": 0,
	"graphTooltip": 0,
	"id": null,
	"links": [],
	"liveNow": false,
	"panels": [
		{
			"datasource": "Prometheus",
			"fieldConfig": {
				"defaults": {
					"min": 0,
					"unit": "ops"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 8,
				"w": 12,
				"x": 0,
				"y": 0
			},
			"id": 1,
			"options": {
				"legend": {
					"displayMode": "table",
					"placement": "bottom"
				},
				"tooltip": {
					"mode": "single"
				}
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "sum by (service_name, result) (rate(synchrotron_sync_attempts_total{service_name=~\"$service\"}[$__rate_interval]))",
					"legendFormat": "{{service_name}} / {{result}}",
					"range": true,
					"refId": "A"
				}
			],
			"title": "Sync attempts / s",
			"type": "timeseries"
		},
		{
			"datasource": "Prometheus",
			"fieldConfig": {
				"defaults": {
					"min": 0,
					"unit": "ms"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 8,
				"w": 12,
				"x": 12,
				"y": 0
			},
			"id": 2,
			"options": {
				"legend": {
					"displayMode": "table",
					"placement": "bottom"
				},
				"tooltip": {
					"mode": "single"
				}
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "histogram_quantile(0.95, sum by (le, service_name) (rate(synchrotron_sync_duration_ms_milliseconds_bucket{service_name=~\"$service\"}[$__rate_interval])))",
					"legendFormat": "{{service_name}} p95",
					"range": true,
					"refId": "A"
				},
				{
					"editorMode": "code",
					"expr": "histogram_quantile(0.5, sum by (le, service_name) (rate(synchrotron_sync_duration_ms_milliseconds_bucket{service_name=~\"$service\"}[$__rate_interval])))",
					"legendFormat": "{{service_name}} p50",
					"range": true,
					"refId": "B"
				}
			],
			"title": "Sync duration (p50/p95)",
			"type": "timeseries"
		},
		{
			"datasource": "Prometheus",
			"fieldConfig": {
				"defaults": {
					"min": 0,
					"unit": "ops"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 8,
				"w": 12,
				"x": 0,
				"y": 8
			},
			"id": 3,
			"options": {
				"legend": {
					"displayMode": "table",
					"placement": "bottom"
				},
				"tooltip": {
					"mode": "single"
				}
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "sum by (rpc_side, rpc_method, result) (rate(synchrotron_rpc_requests_total{service_name=~\"$service\"}[$__rate_interval]))",
					"legendFormat": "{{rpc_side}} / {{rpc_method}} / {{result}}",
					"range": true,
					"refId": "A"
				}
			],
			"title": "RPC requests / s",
			"type": "timeseries"
		},
		{
			"datasource": "Prometheus",
			"fieldConfig": {
				"defaults": {
					"min": 0,
					"unit": "ms"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 8,
				"w": 12,
				"x": 12,
				"y": 8
			},
			"id": 4,
			"options": {
				"legend": {
					"displayMode": "table",
					"placement": "bottom"
				},
				"tooltip": {
					"mode": "single"
				}
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "histogram_quantile(0.95, sum by (le, rpc_side, rpc_method) (rate(synchrotron_rpc_duration_ms_milliseconds_bucket{service_name=~\"$service\"}[$__rate_interval])))",
					"legendFormat": "{{rpc_side}} / {{rpc_method}} p95",
					"range": true,
					"refId": "A"
				},
				{
					"editorMode": "code",
					"expr": "histogram_quantile(0.5, sum by (le, rpc_side, rpc_method) (rate(synchrotron_rpc_duration_ms_milliseconds_bucket{service_name=~\"$service\"}[$__rate_interval])))",
					"legendFormat": "{{rpc_side}} / {{rpc_method}} p50",
					"range": true,
					"refId": "B"
				}
			],
			"title": "RPC duration (p50/p95)",
			"type": "timeseries"
		},
		{
			"datasource": "Prometheus",
			"fieldConfig": {
				"defaults": {
					"min": 0,
					"unit": "ops"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 8,
				"w": 12,
				"x": 0,
				"y": 16
			},
			"id": 5,
			"options": {
				"legend": {
					"displayMode": "table",
					"placement": "bottom"
				},
				"tooltip": {
					"mode": "single"
				}
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "sum by (service_name, severity) (rate(synchrotron_correction_deltas_total{service_name=~\"$service\"}[$__rate_interval]))",
					"legendFormat": "{{service_name}} / {{severity}}",
					"range": true,
					"refId": "A"
				}
			],
			"title": "Correction deltas / s",
			"type": "timeseries"
		},
		{
			"datasource": "Prometheus",
			"fieldConfig": {
				"defaults": {
					"min": 0,
					"unit": "ops"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 8,
				"w": 12,
				"x": 12,
				"y": 16
			},
			"id": 6,
			"options": {
				"legend": {
					"displayMode": "table",
					"placement": "bottom"
				},
				"tooltip": {
					"mode": "single"
				}
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "sum by (service_name) (rate(synchrotron_bootstrap_empty_total{service_name=~\"$service\"}[$__rate_interval]))",
					"legendFormat": "{{service_name}} / bootstrap_empty",
					"range": true,
					"refId": "A"
				},
				{
					"editorMode": "code",
					"expr": "sum by (service_name) (rate(synchrotron_hard_resync_total{service_name=~\"$service\"}[$__rate_interval]))",
					"legendFormat": "{{service_name}} / hard_resync",
					"range": true,
					"refId": "B"
				},
				{
					"editorMode": "code",
					"expr": "sum by (service_name) (rate(synchrotron_rebase_total{service_name=~\"$service\"}[$__rate_interval]))",
					"legendFormat": "{{service_name}} / rebase",
					"range": true,
					"refId": "C"
				}
			],
			"title": "Bootstrap / hard resync / rebase / s",
			"type": "timeseries"
		},
		{
			"datasource": "Prometheus",
			"description": "Gauge (queue depth) sampled during sync loops. It can be useful even when uploads fail (e.g. transient network), but if a client is fully offline from the telemetry backend it cannot export data (so this may show no data).",
			"fieldConfig": {
				"defaults": {
					"unit": "none"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 6,
				"w": 8,
				"x": 0,
				"y": 24
			},
			"id": 7,
			"options": {
				"colorMode": "value",
				"graphMode": "none",
				"justifyMode": "auto",
				"orientation": "horizontal",
				"reduceOptions": {
					"calcs": ["lastNotNull"],
					"fields": "",
					"values": false
				},
				"textMode": "auto"
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "max by (service_name) (synchrotron_local_unsynced_actions_ratio{service_name=~\"$service\"})",
					"legendFormat": "{{service_name}}",
					"range": true,
					"refId": "A"
				}
			],
			"title": "Unsynced local actions",
			"type": "stat"
		},
		{
			"datasource": "Prometheus",
			"description": "Gauge (queue depth) of remote actions that have been ingested into local tables but are still waiting to be applied. Sampled during sync loops.",
			"fieldConfig": {
				"defaults": {
					"unit": "none"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 6,
				"w": 8,
				"x": 8,
				"y": 24
			},
			"id": 8,
			"options": {
				"colorMode": "value",
				"graphMode": "none",
				"justifyMode": "auto",
				"orientation": "horizontal",
				"reduceOptions": {
					"calcs": ["lastNotNull"],
					"fields": "",
					"values": false
				},
				"textMode": "auto"
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "max by (service_name) (synchrotron_remote_unapplied_actions_ratio{service_name=~\"$service\"})",
					"legendFormat": "{{service_name}}",
					"range": true,
					"refId": "A"
				}
			],
			"title": "Remote unapplied actions",
			"type": "stat"
		},
		{
			"datasource": "Prometheus",
			"description": "Gauge (queue depth) of quarantined local actions (upload-gated). Sampled during sync loops.",
			"fieldConfig": {
				"defaults": {
					"unit": "none"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 6,
				"w": 8,
				"x": 16,
				"y": 24
			},
			"id": 9,
			"options": {
				"colorMode": "value",
				"graphMode": "none",
				"justifyMode": "auto",
				"orientation": "horizontal",
				"reduceOptions": {
					"calcs": ["lastNotNull"],
					"fields": "",
					"values": false
				},
				"textMode": "auto"
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "max by (service_name) (synchrotron_quarantined_actions_ratio{service_name=~\"$service\"})",
					"legendFormat": "{{service_name}}",
					"range": true,
					"refId": "A"
				}
			],
			"title": "Quarantined actions",
			"type": "stat"
		},
		{
			"datasource": "Prometheus",
			"fieldConfig": {
				"defaults": {
					"min": 0,
					"unit": "ops"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 8,
				"w": 12,
				"x": 0,
				"y": 30
			},
			"id": 10,
			"options": {
				"legend": {
					"displayMode": "table",
					"placement": "bottom"
				},
				"tooltip": {
					"mode": "single"
				}
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "sum by (service_name, result) (rate(synchrotron_db_statements_total{service_name=~\"$service\"}[$__rate_interval]))",
					"legendFormat": "{{service_name}} / {{result}}",
					"range": true,
					"refId": "A"
				}
			],
			"title": "DB statements / s",
			"type": "timeseries"
		},
		{
			"datasource": "Prometheus",
			"fieldConfig": {
				"defaults": {
					"min": 0,
					"unit": "ms"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 8,
				"w": 12,
				"x": 12,
				"y": 30
			},
			"id": 11,
			"options": {
				"legend": {
					"displayMode": "table",
					"placement": "bottom"
				},
				"tooltip": {
					"mode": "single"
				}
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "histogram_quantile(0.95, sum by (le, service_name) (rate(synchrotron_db_statement_duration_ms_milliseconds_bucket{service_name=~\"$service\"}[$__rate_interval])))",
					"legendFormat": "{{service_name}} p95",
					"range": true,
					"refId": "A"
				},
				{
					"editorMode": "code",
					"expr": "histogram_quantile(0.5, sum by (le, service_name) (rate(synchrotron_db_statement_duration_ms_milliseconds_bucket{service_name=~\"$service\"}[$__rate_interval])))",
					"legendFormat": "{{service_name}} p50",
					"range": true,
					"refId": "B"
				}
			],
			"title": "DB statement duration (p50/p95)",
			"type": "timeseries"
		},
		{
			"datasource": "Prometheus",
			"fieldConfig": {
				"defaults": {
					"min": 0,
					"unit": "ops"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 8,
				"w": 12,
				"x": 0,
				"y": 38
			},
			"id": 12,
			"options": {
				"legend": {
					"displayMode": "table",
					"placement": "bottom"
				},
				"tooltip": {
					"mode": "single"
				}
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "sum by (service_name) (rate(synchrotron_actions_downloaded_total{service_name=~\"$service\"}[$__rate_interval]))",
					"legendFormat": "{{service_name}} downloaded",
					"range": true,
					"refId": "A"
				},
				{
					"editorMode": "code",
					"expr": "sum by (service_name) (rate(synchrotron_actions_uploaded_total{service_name=~\"$service\"}[$__rate_interval]))",
					"legendFormat": "{{service_name}} uploaded",
					"range": true,
					"refId": "B"
				}
			],
			"title": "Actions up/down / s",
			"type": "timeseries"
		},
		{
			"datasource": "Prometheus",
			"fieldConfig": {
				"defaults": {
					"min": 0,
					"unit": "ops"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 8,
				"w": 12,
				"x": 12,
				"y": 38
			},
			"id": 13,
			"options": {
				"legend": {
					"displayMode": "table",
					"placement": "bottom"
				},
				"tooltip": {
					"mode": "single"
				}
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "sum by (service_name) (rate(synchrotron_amrs_downloaded_total{service_name=~\"$service\"}[$__rate_interval]))",
					"legendFormat": "{{service_name}} downloaded",
					"range": true,
					"refId": "A"
				},
				{
					"editorMode": "code",
					"expr": "sum by (service_name) (rate(synchrotron_amrs_uploaded_total{service_name=~\"$service\"}[$__rate_interval]))",
					"legendFormat": "{{service_name}} uploaded",
					"range": true,
					"refId": "B"
				}
			],
			"title": "AMRs up/down / s",
			"type": "timeseries"
		},
		{
			"datasource": "Prometheus",
			"fieldConfig": {
				"defaults": {
					"min": 0,
					"unit": "ops"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 8,
				"w": 12,
				"x": 0,
				"y": 46
			},
			"id": 14,
			"options": {
				"legend": {
					"displayMode": "table",
					"placement": "bottom"
				},
				"tooltip": {
					"mode": "single"
				}
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "sum by (service_name, source) (rate(synchrotron_actions_applied_total{service_name=~\"$service\"}[$__rate_interval]))",
					"legendFormat": "{{service_name}} / {{source}}",
					"range": true,
					"refId": "A"
				}
			],
			"title": "Actions applied / s",
			"type": "timeseries"
		},
		{
			"datasource": "Prometheus",
			"fieldConfig": {
				"defaults": {
					"min": 0,
					"unit": "ms"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 8,
				"w": 12,
				"x": 12,
				"y": 46
			},
			"id": 15,
			"options": {
				"legend": {
					"displayMode": "table",
					"placement": "bottom"
				},
				"tooltip": {
					"mode": "single"
				}
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "histogram_quantile(0.95, sum by (le, service_name) (rate(synchrotron_apply_batch_duration_ms_milliseconds_bucket{service_name=~\"$service\"}[$__rate_interval])))",
					"legendFormat": "{{service_name}} p95",
					"range": true,
					"refId": "A"
				},
				{
					"editorMode": "code",
					"expr": "histogram_quantile(0.5, sum by (le, service_name) (rate(synchrotron_apply_batch_duration_ms_milliseconds_bucket{service_name=~\"$service\"}[$__rate_interval])))",
					"legendFormat": "{{service_name}} p50",
					"range": true,
					"refId": "B"
				}
			],
			"title": "Apply batch duration (p50/p95)",
			"type": "timeseries"
		},
		{
			"datasource": "Prometheus",
			"fieldConfig": {
				"defaults": {
					"min": 0,
					"unit": "ops"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 8,
				"w": 24,
				"x": 0,
				"y": 54
			},
			"id": 16,
			"options": {
				"legend": {
					"displayMode": "table",
					"placement": "bottom"
				},
				"tooltip": {
					"mode": "single"
				}
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "sum by (service_name, case) (rate(synchrotron_sync_case_total{service_name=~\"$service\"}[$__rate_interval]))",
					"legendFormat": "{{service_name}} / {{case}}",
					"range": true,
					"refId": "A"
				}
			],
			"title": "Sync case selection / s",
			"type": "timeseries"
		},
		{
			"datasource": "Prometheus",
			"fieldConfig": {
				"defaults": {
					"max": 100,
					"min": 0,
					"unit": "percent"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 8,
				"w": 12,
				"x": 0,
				"y": 62
			},
			"id": 17,
			"options": {
				"legend": {
					"displayMode": "table",
					"placement": "bottom"
				},
				"tooltip": {
					"mode": "single"
				}
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "100 * ((sum by (service_name) (rate(synchrotron_sync_attempts_total{service_name=~\"$service\",result=\"failure\"}[$__rate_interval])) OR on(service_name) (0 * sum by (service_name) (rate(synchrotron_sync_attempts_total{service_name=~\"$service\"}[$__rate_interval])))) / clamp_min(sum by (service_name) (rate(synchrotron_sync_attempts_total{service_name=~\"$service\"}[$__rate_interval])), 1e-9))",
					"legendFormat": "{{service_name}}",
					"range": true,
					"refId": "A"
				}
			],
			"title": "Sync failure rate (%)",
			"type": "timeseries"
		},
		{
			"datasource": "Prometheus",
			"fieldConfig": {
				"defaults": {
					"max": 100,
					"min": 0,
					"unit": "percent"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 8,
				"w": 12,
				"x": 12,
				"y": 62
			},
			"id": 18,
			"options": {
				"legend": {
					"displayMode": "table",
					"placement": "bottom"
				},
				"tooltip": {
					"mode": "single"
				}
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "100 * ((sum by (service_name) (rate(synchrotron_rpc_requests_total{service_name=~\"$service\",result=\"error\"}[$__rate_interval])) OR on(service_name) (0 * sum by (service_name) (rate(synchrotron_rpc_requests_total{service_name=~\"$service\"}[$__rate_interval])))) / clamp_min(sum by (service_name) (rate(synchrotron_rpc_requests_total{service_name=~\"$service\"}[$__rate_interval])), 1e-9))",
					"legendFormat": "{{service_name}}",
					"range": true,
					"refId": "A"
				}
			],
			"title": "RPC error rate (%)",
			"type": "timeseries"
		},
		{
			"datasource": "Prometheus",
			"fieldConfig": {
				"defaults": {
					"min": 0,
					"unit": "ops"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 8,
				"w": 24,
				"x": 0,
				"y": 70
			},
			"id": 19,
			"options": {
				"legend": {
					"displayMode": "table",
					"placement": "bottom"
				},
				"tooltip": {
					"mode": "single"
				}
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "topk(5, sum by (rpc_side, rpc_method) (rate(synchrotron_rpc_requests_total{service_name=~\"$service\",result=\"error\"}[$__rate_interval])))",
					"legendFormat": "{{rpc_side}} / {{rpc_method}}",
					"range": true,
					"refId": "A"
				}
			],
			"title": "RPC errors / s (top methods)",
			"type": "timeseries"
		},
		{
			"datasource": "Prometheus",
			"fieldConfig": {
				"defaults": {
					"min": 0,
					"unit": "ops"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 8,
				"w": 12,
				"x": 0,
				"y": 78
			},
			"id": 20,
			"options": {
				"legend": {
					"displayMode": "table",
					"placement": "bottom"
				},
				"tooltip": {
					"mode": "single"
				}
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "sum by (service_name, reason) (rate(synchrotron_sync_retries_total{service_name=~\"$service\"}[$__rate_interval]))",
					"legendFormat": "{{service_name}} / {{reason}}",
					"range": true,
					"refId": "A"
				}
			],
			"title": "Sync retries / s",
			"type": "timeseries"
		},
		{
			"datasource": "Prometheus",
			"fieldConfig": {
				"defaults": {
					"min": 0,
					"unit": "ops"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 8,
				"w": 12,
				"x": 12,
				"y": 78
			},
			"id": 21,
			"options": {
				"legend": {
					"displayMode": "table",
					"placement": "bottom"
				},
				"tooltip": {
					"mode": "single"
				}
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "sum by (service_name, reason) (rate(synchrotron_remote_not_ready_total{service_name=~\"$service\"}[$__rate_interval]))",
					"legendFormat": "{{service_name}} / {{reason}}",
					"range": true,
					"refId": "A"
				}
			],
			"title": "Remote not-ready / s",
			"type": "timeseries"
		},
		{
			"datasource": "Prometheus",
			"fieldConfig": {
				"defaults": {
					"min": 0,
					"unit": "ops"
				},
				"overrides": []
			},
			"gridPos": {
				"h": 8,
				"w": 24,
				"x": 0,
				"y": 86
			},
			"id": 22,
			"options": {
				"legend": {
					"displayMode": "table",
					"placement": "bottom"
				},
				"tooltip": {
					"mode": "single"
				}
			},
			"targets": [
				{
					"editorMode": "code",
					"expr": "sum by (rpc_side, rpc_method, reason) (rate(synchrotron_rpc_failures_total{service_name=~\"$service\"}[$__rate_interval]))",
					"legendFormat": "{{rpc_side}} / {{rpc_method}} / {{reason}}",
					"range": true,
					"refId": "A"
				}
			],
			"title": "RPC failures by reason / s",
			"type": "timeseries"
		}
	],
	"refresh": "10s",
	"schemaVersion": 39,
	"style": "dark",
	"tags": ["synchrotron"],
	"templating": {
		"list": [
			{
				"allValue": ".*",
				"current": {
					"selected": true,
					"text": "All",
					"value": "$__all"
				},
				"datasource": "Prometheus",
				"definition": "label_values(synchrotron_rpc_requests_total, service_name)",
				"hide": 0,
				"includeAll": true,
				"multi": true,
				"name": "service",
				"options": [],
				"query": "label_values(synchrotron_rpc_requests_total, service_name)",
				"refresh": 1,
				"regex": "",
				"skipUrlSync": false,
				"sort": 1,
				"type": "query"
			}
		]
	},
	"time": {
		"from": "now-15m",
		"to": "now"
	},
	"timepicker": {},
	"timezone": "",
	"title": "Synchrotron / Overview",
	"uid": "synchrotron-overview",
	"version": 2,
	"weekStart": ""
}
